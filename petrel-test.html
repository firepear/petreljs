<html>
  <head>
    <script src="./demo/sha256.js"></script>
    <script src="petrel-dev.js"></script>
    <script>
var testcount = 0;
var passcount = 0;
function testHeader(msg) {
    console.log("-".repeat(72) + "\n" + msg + "\n" + "-".repeat(72));
}

function test(msg, a, b, invert) {
    testcount++;
    if (invert == true) {
        if (a != b) {
            console.log(msg + " - PASS");
            passcount++;
        } else {
            console.log(msg + " - FAIL: '" + a + "', '" + b + "'");
            throw '';
        }
        return;
    }
    if (a == b) {
        console.log(msg + " - PASS");
        passcount++;
    } else {
        console.log(msg + " - FAIL: '" + a + "', '" + b + "'");
        throw '';
    }
}

testHeader("1 - Instantiate empty Petrel obj");
var p = new Petrel();
test("1.1 p.error should initialize to false", p.error, false);
test("1.2 p.hmac should initialize to null", p.hmac, null);
test("1.3 p.timeout should initialize to 0", p.timeout, 0);
test("1.4 p.ws should initialize to undefined", p.ws, undefined);
test("1.5 p.seq should initialize to 0", p.seq, 0);
test("1.6 p.reqq should have length zero", p.reqq.length, 0);
test("1.7 p.errq should have length zero", p.errq.length, 0);

testHeader("2 - Instantiate non-default Petrel obj");
p = new Petrel(50, "foo");
test("2.1 p.error should initialize to false", p.error, false);
test("2.2 p.hmac should initialize to 'foo'", p.hmac, "foo");
test("2.3 p.timeout should initialize to 50", p.timeout, 50);
test("2.4 p.ws should initialize to undefined", p.ws, undefined);
test("2.5 p.seq should initialize to 0", p.seq, 0);
test("2.6 p.reqq should have length zero", p.reqq.length, 0);
test("2.7 p.errq should have length zero", p.errq.length, 0);

testHeader("3 - Message marshalling");
p = new Petrel();
msg = petrelMarshal(p, "hello, world");
test("3.1 p.errq should have length zero", p.errq.length, 0);
test("3.2 msg should be defined", msg, undefined, true);
test("3.3 msg.size should be 21 (4+4+1+12)", msg.size, 21);
p.seq = 1;
msg = petrelMarshal(p, "hello, world");

x1 = msg.slice(0,4);
r1 = new FileReader();
r1.onload = function(evt) {
    x2 = evt.target.result;
    x3 = new Uint32Array(x2);
    test("3.4 seq should be 1", x3[0], 1);
};
r1.readAsArrayBuffer(x1);

x1 = msg.slice(4,8);
r2 = new FileReader();
r2.onload = function(evt) {
    x2 = evt.target.result;
    x3 = new Uint32Array(x2);
    test("3.5 plen should be 12", x3[0], 12);
};
r2.readAsArrayBuffer(x1);

x1 = msg.slice(8,9);
r3 = new FileReader();
r3.onload = function(evt) {
    x2 = evt.target.result;
    x3 = new Uint8Array(x2);
    test("3.6 pver should be 0", x3[0], 0);
};
r3.readAsArrayBuffer(x1);

x1 = msg.slice(9,21);
r4 = new FileReader();
r4.onload = function(evt) {
    x2 = evt.target.result;
    test("3.7 payload should be 'hello, world'", x2, "hello, world");
};
r4.readAsText(x1);

// ----------------------------------------------------------  end tests
</script>
  </head>
  <body>
    Test results are in the Javascript console.
  </body>
</html>
